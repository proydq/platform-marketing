# 表结构说明
**项目名称：** 海外自动化营销系统  
**版本号：** V1.0  
**发布日期：** 2025-08-08  
**撰写人：** 数据架构部  

> 说明：本文件描述 V1.0 的核心业务表结构、字段、索引与约束。默认数据库为 **MySQL 8.x**，字符集 **utf8mb4**，排序规则 **utf8mb4_0900_ai_ci**。时间统一使用 UTC，字段命名采用 `snake_case`。

---

## 0. 通用设计规范

- **审计字段**：`created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3)`、`updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3)`、`created_by BIGINT NULL`、`updated_by BIGINT NULL`
- **软删除**（可选）：`deleted_at DATETIME(3) NULL`
- **主键**：`BIGINT` 自增或分布式（Snowflake/ULID），本文默认自增。
- **多租户**（可选）：如需 SaaS 化，增加 `tenant_id BIGINT NOT NULL` 并在所有业务表与索引中包含。
- **JSON 扩展**：可扩展字段统一使用 `json`，如 `ext`、`meta`。
- **外键**：为简化迁移与高并发，生产建议逻辑外键（应用层保障一致性）；开发/测试环境可开启物理外键。

---

## 1. 客户与标签

### 1.1 `customer`（客户主表）
| 字段         | 类型         | 约束                | 说明                                |
| ------------ | ------------ | ------------------- | ----------------------------------- |
| id           | BIGINT       | PK, AUTO_INCREMENT  | 客户ID                              |
| company_name | VARCHAR(255) | NOT NULL            | 公司名称                            |
| contact_name | VARCHAR(255) | NULL                | 联系人                              |
| email        | VARCHAR(255) | NULL, UNIQUE(email) | 邮箱（用于邮件渠道）                |
| phone        | VARCHAR(64)  | NULL                | 电话（国际区号+号码）               |
| whatsapp     | VARCHAR(64)  | NULL                | WhatsApp 号码（含国家码）           |
| linkedin_url | VARCHAR(255) | NULL                | LinkedIn 主页或个人链接             |
| country      | VARCHAR(64)  | NULL                | 国家/地区                           |
| industry     | VARCHAR(128) | NULL                | 行业                                |
| website      | VARCHAR(255) | NULL                | 公司网站                            |
| address      | VARCHAR(512) | NULL                | 地址                                |
| size_bucket  | VARCHAR(32)  | NULL                | 公司规模（如 1-10/11-50/…）         |
| buyer_role   | VARCHAR(64)  | NULL                | 采购角色（决策人/影响者/执行者）    |
| source       | VARCHAR(64)  | NULL                | 线索来源（import/api/crawler/expo） |
| score        | INT          | DEFAULT 0           | 线索评分（AI/规则）                 |
| ext          | JSON         | NULL                | 自定义属性（键值）                  |
| created_at   | DATETIME(3)  | NOT NULL            | 创建时间                            |
| updated_at   | DATETIME(3)  | NOT NULL            | 更新时间                            |

**索引建议**
- `UK_customer_email(email)`
- `IDX_customer_company(company_name)`
- `IDX_customer_country_industry(country, industry)`
- 如启用多租户：`IDX_customer_tenant(tenant_id, email)`

---

### 1.2 `customer_tag`（客户标签）
| 字段        | 类型        | 约束               | 说明                                 |
| ----------- | ----------- | ------------------ | ------------------------------------ |
| id          | BIGINT      | PK, AUTO_INCREMENT | 标签记录ID                           |
| customer_id | BIGINT      | NOT NULL           | 客户ID                               |
| tag_name    | VARCHAR(64) | NOT NULL           | 标签名（如：display、retailer、VIP） |
| created_at  | DATETIME(3) | NOT NULL           | 创建时间                             |

**索引与约束**
- `IDX_ctag_cust(customer_id)`
- `UK_ctag(customer_id, tag_name)` 防止重复打标

---

### 1.3 `segment`（客户分组）
| 字段        | 类型         | 约束               | 说明                       |
| ----------- | ------------ | ------------------ | -------------------------- |
| id          | BIGINT       | PK, AUTO_INCREMENT | 分组ID                     |
| name        | VARCHAR(128) | NOT NULL, UNIQUE   | 分组名称                   |
| description | VARCHAR(512) | NULL               | 分组描述                   |
| rule_json   | JSON         | NULL               | 分组规则（保存筛选器 DSL） |
| created_at  | DATETIME(3)  | NOT NULL           | 创建时间                   |

**索引**
- `UK_segment_name(name)`

---

### 1.4 `segment_customer`（分组-客户关联）
| 字段        | 类型        | 约束               | 说明     |
| ----------- | ----------- | ------------------ | -------- |
| id          | BIGINT      | PK, AUTO_INCREMENT | 记录ID   |
| segment_id  | BIGINT      | NOT NULL           | 分组ID   |
| customer_id | BIGINT      | NOT NULL           | 客户ID   |
| created_at  | DATETIME(3) | NOT NULL           | 创建时间 |

**索引与约束**
- `IDX_seg_cust(segment_id, customer_id)`
- `UK_seg_customer(segment_id, customer_id)` 防重复

---

## 2. 模板与内容版本

### 2.1 `template`（模板库）
| 字段       | 类型         | 约束               | 说明                            |
| ---------- | ------------ | ------------------ | ------------------------------- |
| id         | BIGINT       | PK, AUTO_INCREMENT | 模板ID                          |
| name       | VARCHAR(128) | NOT NULL           | 模板名称                        |
| language   | VARCHAR(16)  | NOT NULL           | 语言（en/es/fr/…）              |
| channel    | VARCHAR(32)  | NOT NULL           | 渠道（email/whatsapp/linkedin） |
| content    | MEDIUMTEXT   | NOT NULL           | 模板内容（含变量）              |
| variables  | JSON         | NULL               | 变量清单（占位符定义与示例）    |
| created_at | DATETIME(3)  | NOT NULL           | 创建时间                        |
| updated_at | DATETIME(3)  | NOT NULL           | 更新时间                        |

**索引**
- `IDX_tpl_lang_channel(language, channel)`

---

### 2.2 `content_version`（生成内容版本）
| 字段        | 类型        | 约束               | 说明                                 |
| ----------- | ----------- | ------------------ | ------------------------------------ |
| id          | BIGINT      | PK, AUTO_INCREMENT | 版本ID                               |
| template_id | BIGINT      | NULL               | 来源模板                             |
| customer_id | BIGINT      | NULL               | 针对客户个性化生成                   |
| segment_id  | BIGINT      | NULL               | 针对分组批量生成                     |
| language    | VARCHAR(16) | NOT NULL           | 语言                                 |
| channel     | VARCHAR(32) | NOT NULL           | 渠道                                 |
| variables   | JSON        | NULL               | 最终变量映射（如 {{company}}）       |
| content     | MEDIUMTEXT  | NOT NULL           | 渠道发送内容（已渲染）               |
| ab_group    | VARCHAR(8)  | NULL               | A/B 分组标记（A/B/...）              |
| meta        | JSON        | NULL               | 生成元数据（模型、温度、提示词摘要） |
| created_at  | DATETIME(3) | NOT NULL           | 创建时间                             |

**索引**
- `IDX_cver_target(customer_id, segment_id, channel)`
- `IDX_cver_tpl(template_id)`

---

## 3. 发送任务与消息

### 3.1 `send_task`（发送任务批次）
| 字段          | 类型         | 约束                       | 说明                                                  |
| ------------- | ------------ | -------------------------- | ----------------------------------------------------- |
| id            | BIGINT       | PK, AUTO_INCREMENT         | 任务ID                                                |
| name          | VARCHAR(128) | NOT NULL                   | 任务名称                                              |
| channel       | VARCHAR(32)  | NOT NULL                   | 渠道                                                  |
| segment_id    | BIGINT       | NULL                       | 目标分组                                              |
| schedule_time | DATETIME(3)  | NULL                       | 计划开始时间                                          |
| frequency     | VARCHAR(32)  | NULL                       | 频率（一次性/每日/每周/...）                          |
| priority      | TINYINT      | DEFAULT 5                  | 优先级（1高-9低）                                     |
| status        | VARCHAR(32)  | NOT NULL DEFAULT 'pending' | 任务状态（pending/running/completed/canceled/failed） |
| ext           | JSON         | NULL                       | 扩展配置（频控、速率、窗口）                          |
| created_at    | DATETIME(3)  | NOT NULL                   | 创建时间                                              |
| updated_at    | DATETIME(3)  | NOT NULL                   | 更新时间                                              |

**索引**
- `IDX_task_channel_status(channel, status)`
- `IDX_task_schedule(schedule_time)`

---

### 3.2 `message`（单条消息）
| 字段               | 类型         | 约束                       | 说明                                  |
| ------------------ | ------------ | -------------------------- | ------------------------------------- |
| id                 | BIGINT       | PK, AUTO_INCREMENT         | 消息ID                                |
| task_id            | BIGINT       | NULL                       | 所属任务                              |
| customer_id        | BIGINT       | NOT NULL                   | 客户ID                                |
| content_version_id | BIGINT       | NULL                       | 内容版本ID                            |
| channel            | VARCHAR(32)  | NOT NULL                   | 渠道（email/whatsapp/linkedin）       |
| recipient          | VARCHAR(255) | NOT NULL                   | 目标地址（邮箱/号码/URL）             |
| subject            | VARCHAR(255) | NULL                       | 邮件标题（仅 email）                  |
| content            | MEDIUMTEXT   | NOT NULL                   | 发送内容（最终文本）                  |
| status             | VARCHAR(32)  | NOT NULL DEFAULT 'pending' | pending/sent/delivered/failed/bounced |
| scheduled_at       | DATETIME(3)  | NULL                       | 计划发送时间                          |
| sent_at            | DATETIME(3)  | NULL                       | 实际发送时间                          |
| fail_code          | VARCHAR(64)  | NULL                       | 失败码（供应商/自定义）               |
| fail_reason        | VARCHAR(512) | NULL                       | 失败原因                              |
| retry_count        | TINYINT      | DEFAULT 0                  | 重试次数                              |
| meta               | JSON         | NULL                       | 供应商响应、MessageId 等              |
| created_at         | DATETIME(3)  | NOT NULL                   | 创建时间                              |
| updated_at         | DATETIME(3)  | NOT NULL                   | 更新时间                              |

**索引**
- `IDX_msg_task(task_id)`
- `IDX_msg_cust(customer_id)`
- `IDX_msg_status(status, scheduled_at)`
- 幂等建议：`UK_msg_dedup(task_id, customer_id, channel)` 或（`channel`,`recipient`,`scheduled_at`粒度）

---

### 3.3 `track_event`（行为事件）
| 字段       | 类型         | 约束               | 说明                            |
| ---------- | ------------ | ------------------ | ------------------------------- |
| id         | BIGINT       | PK, AUTO_INCREMENT | 事件ID                          |
| message_id | BIGINT       | NOT NULL           | 消息ID                          |
| event_type | VARCHAR(32)  | NOT NULL           | open/click/reply/bounce/deliver |
| event_time | DATETIME(3)  | NOT NULL           | 事件时间                        |
| user_agent | VARCHAR(255) | NULL               | UA                              |
| ip         | VARCHAR(64)  | NULL               | IP 地址                         |
| url        | VARCHAR(512) | NULL               | 点击链接（event_type=click）    |
| meta       | JSON         | NULL               | 原始事件负载                    |
| created_at | DATETIME(3)  | NOT NULL           | 创建时间                        |

**索引**
- `IDX_event_msg(message_id, event_type, event_time)`
- `IDX_event_type(event_type, event_time)`

---

### 3.4 `blacklist`（退订/黑名单）
| 字段       | 类型         | 约束               | 说明                                 |
| ---------- | ------------ | ------------------ | ------------------------------------ |
| id         | BIGINT       | PK, AUTO_INCREMENT | 记录ID                               |
| channel    | VARCHAR(32)  | NOT NULL           | 渠道                                 |
| recipient  | VARCHAR(255) | NOT NULL           | 地址/号码                            |
| reason     | VARCHAR(128) | NULL               | 原因（unsubscribe/bounce/complaint） |
| source     | VARCHAR(64)  | NULL               | 来源（系统/供应商）                  |
| created_at | DATETIME(3)  | NOT NULL           | 创建时间                             |

**索引与约束**
- `UK_blacklist(channel, recipient)`  
- 发送前需全局拦截

---

## 4. 账号与权限

### 4.1 `user`（用户）
| 字段          | 类型         | 约束               | 说明                            |
| ------------- | ------------ | ------------------ | ------------------------------- |
| id            | BIGINT       | PK, AUTO_INCREMENT | 用户ID                          |
| username      | VARCHAR(64)  | NOT NULL, UNIQUE   | 用户名                          |
| password_hash | VARCHAR(255) | NOT NULL           | 密码哈希（BCrypt/Argon2）       |
| email         | VARCHAR(255) | NULL               | 邮箱                            |
| role          | VARCHAR(32)  | NOT NULL           | 角色（admin/ops/sales/analyst） |
| last_login_at | DATETIME(3)  | NULL               | 最后登录                        |
| created_at    | DATETIME(3)  | NOT NULL           | 创建时间                        |
| updated_at    | DATETIME(3)  | NOT NULL           | 更新时间                        |

**索引**
- `UK_user_username(username)`

---

### 4.2 `role_permission`（角色-权限）
| 字段       | 类型        | 约束               | 说明                                       |
| ---------- | ----------- | ------------------ | ------------------------------------------ |
| id         | BIGINT      | PK, AUTO_INCREMENT | 记录ID                                     |
| role       | VARCHAR(32) | NOT NULL           | 角色                                       |
| permission | VARCHAR(64) | NOT NULL           | 权限标识（如 customer.read、message.send） |

**索引与约束**
- `UK_role_perm(role, permission)`

---

## 5. A/B 测试与意向池

### 5.1 `ab_test`（A/B 测试配置）
| 字段       | 类型         | 约束                      | 说明                         |
| ---------- | ------------ | ------------------------- | ---------------------------- |
| id         | BIGINT       | PK, AUTO_INCREMENT        | 测试ID                       |
| name       | VARCHAR(128) | NOT NULL                  | 测试名称                     |
| target     | VARCHAR(32)  | NOT NULL                  | 目标（open/click/reply）     |
| variants   | JSON         | NOT NULL                  | 变体定义（A/B 比例与版本ID） |
| status     | VARCHAR(16)  | NOT NULL DEFAULT 'active' | active/paused/completed      |
| created_at | DATETIME(3)  | NOT NULL                  | 创建时间                     |
| updated_at | DATETIME(3)  | NOT NULL                  | 更新时间                     |

---

### 5.2 `intent_pool`（意向客户池）
| 字段        | 类型         | 约束               | 说明                                  |
| ----------- | ------------ | ------------------ | ------------------------------------- |
| id          | BIGINT       | PK, AUTO_INCREMENT | 记录ID                                |
| customer_id | BIGINT       | NOT NULL           | 客户ID                                |
| stage       | VARCHAR(32)  | NOT NULL           | 阶段（new/interested/qualified/lost） |
| score       | INT          | DEFAULT 0          | 评分                                  |
| note        | VARCHAR(512) | NULL               | 备注                                  |
| updated_by  | BIGINT       | NULL               | 更新人                                |
| updated_at  | DATETIME(3)  | NOT NULL           | 更新时间                              |
| created_at  | DATETIME(3)  | NOT NULL           | 创建时间                              |

**索引**
- `UK_intent_customer(customer_id)`
- `IDX_intent_stage(stage, score)`

---

## 6. 发送账号与渠道配置（可选但推荐）

### 6.1 `channel_account`（渠道账号）
| 字段       | 类型         | 约束                      | 说明                                   |
| ---------- | ------------ | ------------------------- | -------------------------------------- |
| id         | BIGINT       | PK, AUTO_INCREMENT        | 账号ID                                 |
| channel    | VARCHAR(32)  | NOT NULL                  | 渠道                                   |
| name       | VARCHAR(128) | NOT NULL                  | 账号别名                               |
| config     | JSON         | NOT NULL                  | 配置（API Key、域名、速率、模板ID 等） |
| status     | VARCHAR(16)  | NOT NULL DEFAULT 'active' | active/paused                          |
| created_at | DATETIME(3)  | NOT NULL                  | 创建时间                               |
| updated_at | DATETIME(3)  | NOT NULL                  | 更新时间                               |

**索引**
- `IDX_cacc_channel_status(channel, status)`

---

### 6.2 `sender_profile`（发信人配置/签名）
| 字段               | 类型         | 约束               | 说明                    |
| ------------------ | ------------ | ------------------ | ----------------------- |
| id                 | BIGINT       | PK, AUTO_INCREMENT | 配置ID                  |
| channel_account_id | BIGINT       | NOT NULL           | 关联渠道账号            |
| sender_name        | VARCHAR(128) | NULL               | 发件人名称/签名         |
| sender_address     | VARCHAR(255) | NULL               | 发件人地址（邮箱/号码） |
| headers            | JSON         | NULL               | 自定义头（邮件）        |
| footer             | TEXT         | NULL               | 统一页脚/退订信息       |
| created_at         | DATETIME(3)  | NOT NULL           | 创建时间                |
| updated_at         | DATETIME(3)  | NOT NULL           | 更新时间                |

**索引**
- `IDX_sender_acc(channel_account_id)`

---

## 7. 错误与退信

### 7.1 `bounce_log`（退信日志）
| 字段        | 类型         | 约束               | 说明                   |
| ----------- | ------------ | ------------------ | ---------------------- |
| id          | BIGINT       | PK, AUTO_INCREMENT | 日志ID                 |
| message_id  | BIGINT       | NOT NULL           | 消息ID                 |
| bounce_type | VARCHAR(32)  | NOT NULL           | 硬退/软退（hard/soft） |
| code        | VARCHAR(64)  | NULL               | 供应商退信码           |
| reason      | VARCHAR(512) | NULL               | 退信原因               |
| occurred_at | DATETIME(3)  | NOT NULL           | 发生时间               |
| created_at  | DATETIME(3)  | NOT NULL           | 记录时间               |

**索引**
- `IDX_bounce_msg(message_id, occurred_at)`

---

## 8. 索引与性能建议（摘要）

- 高频查询路径：
  - **客户检索**：`country + industry + tag_name` 组合，建议物化（视图或离线表）或 ES；
  - **任务/消息看板**：`status + scheduled_at`；
  - **行为分析**：`event_type + event_time` 时间序列聚合；
- 批量发送：
  - 使用 **队列**（Redis Stream/Kafka），在 `message` 上仅落地状态与必要元数据；
- 报表场景：
  - 将 `message` 与 `track_event` 复制到 **ClickHouse** 进行聚合分析，MySQL 只保留近 90 天热数据。

---

## 9. 命名与约束风格

- 表名：单词下划线复数优先（如 `customers`），本文沿用单数以贴合前述 ER 图；落库时可统一切换。
- 枚举：保持小写短字符串，集中到应用层常量或 MySQL CHECK 约束（8.0.16+）。
- 字段长度：邮箱 255、URL 255-512、电话 64。
- 隐私：`email/phone/whatsapp/linkedin_url` 在日志与导出需脱敏或按权限输出。

---

## 10. 变更记录
- **V1.0**：定义客户、标签、分组、模板、内容版本、任务、消息、事件、黑名单、AB 测试、意向池、渠道账号、发信人、退信等核心表。

---