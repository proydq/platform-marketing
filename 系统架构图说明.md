# 系统架构图说明
**项目名称：** 海外自动化营销系统  
**版本号：** V1.0  
**发布日期：** 2025-08-08  
**撰写人：** 技术架构部  

> 说明：本文使用 Mermaid 绘制架构图。若在本地无法渲染，请在支持 Mermaid 的 Markdown 工具中打开（如 VSCode + Markdown Preview Mermaid、Typora、Obsidian、GitLab/GitHub 部分场景等）。

---

## 1. 总体架构（分层视图）

```mermaid
graph TD
  A[表示层<br/>Vue3 + Element Plus + i18n] --> B[应用层/微服务]
  B --> B1[数据采集服务<br/>导入/API/爬虫/清洗]
  B --> B2[客户管理服务<br/>标签/分组/去重/画像]
  B --> B3[内容生成服务<br/>模板库/AI生成/多语言]
  B --> B4[渠道触达服务<br/>邮件/WhatsApp/LinkedIn/排程]
  B --> B5[行为跟踪服务<br/>打开/点击/回复埋点]
  B --> B6[分析与报表服务<br/>AB测试/ROI/看板]
  B --> B7[系统管理服务<br/>用户/权限/审计/通知]

  B --> C[数据层]
  C --> C1[(MySQL<br/>业务数据)]
  C --> C2[(Redis<br/>缓存/队列)]
  C --> C3[(Elasticsearch<br/>日志/检索)]
  C --> C4[(数据仓库/可选<br/>ClickHouse/BigQuery)]
  C --> C5[(对象存储/可选<br/>附件/导出文件)]

  B --> D[集成层]
  D --> D1[[海关数据 API]]
  D --> D2[[展会数据 API]]
  D --> D3[[WhatsApp Business API]]
  D --> D4[[LinkedIn 插件/半自动脚本]]
  D --> D5[[OpenAI/GPT API]]
  D --> D6[[邮件网关 SMTP/SES/SendGrid]]
  D --> D7[[日历集成 Google/Outlook]]

  classDef layer fill:#f5f8ff,stroke:#6b93ff,stroke-width:1px;
  class A,B,C,D layer;
```

**解读要点**
- **表示层**：统一的运营与管理界面。
- **应用层**：按领域拆分服务，天然支持横向扩展。
- **数据层**：冷热分离，缓存/检索/仓库分工明确。
- **集成层**：第三方服务与外部系统统一由集成层治理。

---

## 2. 服务交互与数据流（关键业务链路）

```mermaid
sequenceDiagram
  autonumber
  participant U as 运营/销售用户
  participant FE as Web前端
  participant IMP as 数据采集服务
  participant CRM as 客户管理服务
  participant GEN as 内容生成服务
  participant CH as 渠道触达服务
  participant TRK as 行为跟踪服务
  participant ANA as 分析报表服务
  participant DB as MySQL/Redis/ES

  U->>FE: 上传线索/配置采集任务
  FE->>IMP: 提交导入/爬虫/API任务
  IMP->>DB: 写入原始数据(ODS)
  IMP->>CRM: 触发清洗/去重/画像
  CRM->>DB: 客户主数据+标签入库

  U->>FE: 选择客户分组&模板
  FE->>GEN: 请求AI个性化文案
  GEN->>DB: 记录内容版本与变量映射
  GEN-->>FE: 返回可编辑内容

  FE->>CH: 创建发送任务(渠道/时间/频率)
  CH->>DB: 持久化任务&入队(Redis/队列)
  CH-->>外部: 邮件/WhatsApp/LinkedIn 发送
  TRK-->>DB: 投递打开/点击/回复事件
  TRK-->>CH: 失败重试/退订规则

  ANA->>DB: 汇总埋点/任务/转化
  ANA-->>FE: 展示报表/AB测试结果
  FE-->>U: 产出下一轮策略建议
```

**解读要点**
- 事件埋点由 **行为跟踪服务** 统一采集，避免各服务各自为政。
- **内容生成服务** 记录“版本-变量映射”，便于 AB 与复盘。
- **渠道触达服务** 统一排程/重试/频控/退订治理，降低封号与拒收风险。

---

## 3. 部署拓扑（生产环境建议）

```mermaid
graph LR
  subgraph Client
    U[用户浏览器]
  end

  subgraph Edge
    CDN[CDN/静态资源]:::edge
    WAF[WAF/防火墙]:::edge
  end

  subgraph AppCluster[K8s 集群/多可用区]
    G[API Gateway/Ingress]
    FE[Web前端 Pod]
    S1[数据采集服务]
    S2[客户管理服务]
    S3[内容生成服务]
    S4[渠道触达服务]
    S5[行为跟踪服务]
    S6[分析与报表服务]
    S7[系统管理服务]
    MQ[消息队列/可选 Kafka/RabbitMQ]
  end

  subgraph Data[托管数据层]
    R[(Redis)]
    M[(MySQL 主从)]
    E[(Elasticsearch)]
    DW[(数据仓库/ClickHouse)]
    OBJ[(对象存储/S3)]
  end

  subgraph Ext[外部依赖]
    WA[[WhatsApp Business API]]
    LI[[LinkedIn/插件接口]]
    AI[[OpenAI/GPT]]
    SMTP[[SMTP/SES/SendGrid]]
    CAL[[Google/Outlook Calendar]]
    CUS[[海关/展会 API]]
  end

  U --> CDN --> WAF --> G
  G --> FE
  G --> S1 & S2 & S3 & S4 & S5 & S6 & S7
  S1 & S2 & S3 & S4 & S5 & S6 & S7 --> MQ
  S1 & S2 & S3 & S4 & S5 & S6 & S7 --> M & R & E & DW & OBJ
  S1 --> CUS
  S3 --> AI
  S4 --> WA & LI & SMTP & CAL

  classDef edge fill:#eef9f1,stroke:#2fb07f,stroke-width:1px;
```

**解读要点**
- **WAF + Ingress**：统一入口与安全策略。
- **消息队列**：削峰填谷、异步解耦（大批量发送/重试尤为关键）。
- **数据主从/多AZ**：提升可用性与读性能。
- **对象存储**：用于模板附件、导出文件、日志归档等。

---

## 4. 核心非功能设计要点
- **可观测性**：应用日志（结构化 JSON）→ ES；指标 → Prometheus/Grafana；链路追踪 → OpenTelemetry。
- **弹性与限流**：发送任务按渠道频控，Tenant/账号级 QPS 限制，灰度发布。
- **容错与重试**：幂等键（任务ID+收件人+渠道），指数退避重试；失败原因分类（硬退信/软退信/封禁/网络）。
- **数据合规**：GDPR/CCPA，数据遮蔽与可删除请求（Right to be forgotten），退订/黑名单全局治理。
- **多租户**（可选）：Tenant 隔离（逻辑库/表前缀/行级安全），配置与配额独立。

---

## 5. 渠道治理策略（摘要）
- **邮件**：SPF/DKIM/DMARC 配置；冷热 IP；退订/垃圾标记收敛；分层白名单。
- **WhatsApp**：模板消息审批；24h 会话窗口合规；号码信誉分级；发送速率分档。
- **LinkedIn**：半自动/人工辅助（避免批量自动化触发风控）；节奏与话术多样化。

---

## 6. 图例（Legend）
- **矩形**：服务/组件  
- **圆角矩形**：逻辑分层/分组  
- **双圆**：持久化存储  
- **虚线箭头**：外部依赖/第三方

---